<h2>IP导入导出</h2>
<div class="alert fade in hide">
    <button type="button" class="close" data-dismiss="alert">×</button>
    <p class="message"></p>
</div> <!-- .alert -->

<form method="POST" onSubmit="onSubmit(); return false;">
    <div class="row-fluid">
        <div class="span2">
            <label for="action">任务类型</label>
        </div> <!-- .span2 -->
        <div class="span8">
            <div class="row-fluid">
                <div class="span6">
                    <input id="action" name="action" type="radio" value="import" checked />导入
                </div> <!-- .span6 -->
                <div class="span6">
                    <input id="action" name="action" type="radio" value="export" />导出
                </div> <!-- .span6 -->
            </div> <!-- .row-fluid -->
        </div> <!-- .span8 -->
    </div> <!-- .row-fluid -->
    <div class="row-fluid">
        <div class="span2">
            <label for="ip-format">导入/导出格式</label>
        </div> <!-- .span2 -->
        <div class="span10">
            <select id="ip-format">
                <option value="1" selected>IP|IP|IP (Gogo-Tester/Goagent格式)</option>
                <option value="2">换行分割</option>
                <option value="3">智能正则匹配</option>
            </select>
        </div> <!-- .span10 -->
    </div> <!-- .row-fluid -->
    <div class="row-fluid">
        <div class="span2">
            <label for="ip-list">IP列表</label>
        </div> <!-- .span2 -->
        <div class="span10">
            <textarea id="ip-list" rows="10"></textarea>
        </div> <!-- .span10 -->
    </div> <!-- .row-fluid -->

    <div class="row-fluid">
        <div class="span12">
            <button class="btn btn-primary btn-block" type="submit">执行</button>
        </div> <!-- .span12 -->
    </div> <!-- .row-fluid -->
</form> <!-- #import-export-ip -->

<!-- JavaScript -->
<script type="text/javascript">
    function onSubmit() {
        var action   = $('#action:checked').val(),
            ipFormat = $('#ip-format').val(),
            ipList   = $('#ip-list').val();

        if ( action == 'import' ) {
            return doImportAction(ipFormat, ipList);
        } else if ( action == 'export' ) {
            return doExportAction(ipFormat, ipList);
        }
    }
</script>
<script type="text/javascript">
    $('input[name="action"]').click(function() {
        var action = $('#action:checked').val();
        var option = $('option[value=3]');

        if( action == 'import' ) {
            option.css('display', '');
        } else if ( action == 'export' ) {
            option.css('display', 'none');
            if( $('#ip-format').val() == 3 ) {
                $('#ip-format').val("1");
            }
        }
    });
</script>
<script type="text/javascript">
    function doImportAction(ipFormat, ipList) {
        var ipList = conversionFormat(ipFormat, '1', ipList);
        var postData = {
            'ipList': ipList
        };

        $.ajax({
            type: 'POST',
            url: 'http://127.0.0.1:8084/importip?cmd=importip',
            data: postData,
            dataType: 'JSON',
            success: function(result) {
                alert('成功导入' + result['res'] + '个IP.', 'success');
            },
            error: function() {
                alert('导入IP失败');
            }
        });
    }
</script>
<script type="text/javascript">
    function doExportAction(ipFormat, ipList) {
        $.ajax({
            type: 'POST',
            url: 'http://127.0.0.1:8084/importip?cmd=exportip',
            dataType: 'JSON',
            success: function(result) {
                var ipList = result['res'];
                ipList = conversionFormat('1', ipFormat, ipList);

                $('#ip-list').val(ipList);
                alert('导出成功.', 'success');
            },
            error: function() {
                alert('导出IP失败.', 'error');
            }
        });
    }
</script>
<script type="text/javascript">
    function conversionFormat(sf, tf, ss) {
        if( sf == tf ) {
            return ss;
        }

        var ipList;
        if( sf == 1 ) {
            ipList = ss.split("|");
        } else if( sf == 2 ) {
            ipList = ss.split("\n");  
        } else if( sf == 3 ) {
            ipList = ss.match(/(([1-9]?\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}([1-9]?\d|1\d{2}|2[0-4]\d|25[0-5])/g);
        }

        var result;
        if( tf == 1 ) {
            result = '';
            for(var id in ipList) {
                result += ipList[id] + '|';
            }
            result = result.substr(0, result.length - 1);
        } else if( tf == 2 ) {
            result = '';
            for(var id in ipList) {
                result += ipList[id] + '\n';
            }
        }

        return result;
    }
</script>
<script type="text/javascript">
    function alert(message, type) {
        $('.message', '.alert').html(message);
        $('.alert').removeClass('alert-error');
        $('.alert').removeClass('alert-success');
        $('.alert').removeClass('hide');
        $('.alert').addClass('alert-' + type);
    }
</script>