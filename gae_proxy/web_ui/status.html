<!--[if lte IE 9]>
<div class="alert alert-warning">
    {{ _( "Your browser is obsolete. Partial functionality will not be available." ) }}<br>
    {{ _( "The latest Chrome browser is recommended." ) }}
</div>
<![endif]-->

<div pro="False">
    </br></br></br>
    <div id="noob-info"></div>
    </br></br></br>

    <!-- show pro="True" and hide pro="False"-->
    <button id="show_detail" class="btn btn-primary">{{ _( "Show Detail" ) }}</button>

</div>

<h4 pro="True" hidden>{{ _( "Status" ) }}</h4>
<table id="status" class="table table-bordered table-striped" pro="True" hidden>
    <thead>
        <tr>
            <th width="25%">{{ _( "Property" ) }}</th>
            <th>{{ _( "Value" ) }}</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ _( "Local Network Status" ) }}</td>
            <td id="network-status"></td>
        </tr>
        <tr>
            <td>{{ _( "IP Number" ) }}</td>
            <td id="ip-num"></td>
        </tr>
        <tr>
            <td>{{ _( "IP Quality" ) }}</td>
            <td id="ip-quality"></td>
        </tr>
        <tr>
            <td>{{ _( "Connection Pool" ) }}(<a href="https://github.com/XX-net/XX-Net/wiki/GoAgent-Connection-status" target="_blank">{{ _( "Help" ) }}</a>)</td>
            <td id="connection-status"></td>
        </tr>
        <tr>
            <td>{{ _( "Browser Proxy Setting" ) }}</td>
            <td id="browser-proxy-setting"></td>
        </tr>
        <tr id="tr_ca-status">
            <td>{{ _( "CA status" ) }}</td>
            <td id="ca-status"></td>
        </tr>
        <tr>
            <td>{{ _( "Number of IP-Scanning Threads" ) }}(<a href="/?module=gae_proxy&menu=scan_ip">{{ _( "Settings" ) }}</a>)</td>
            <td id="scan-ip-thread-num"></td>
        </tr>
        <tr>
            <td>{{ _( "Block Status" ) }} (<a href="https://github.com/XX-net/XX-Net/wiki/GoAgent-Blocked" target="_blank">{{ _( "Help" ) }}</a>)</td>
            <td id="block-stat"></td>
        </tr>
        <!--tr pro="False">
            <td>{{ _( "XX-Net Version" ) }}</td>
            <td id="xxnet-version"></td>
        </tr-->
    </tbody>
</table>

<h4 pro="True" hidden>{{ _( "Configuration" ) }}</h4>
<table id="setting" class="table table-bordered table-striped" pro="True" hidden>
    <thead>
        <tr>
            <th width="25%">{{ _( "Property" ) }}</th>
            <th>{{ _( "Value" ) }}</th>
        </tr>
    </thead>
    <tbody>
        <tr hidden>
            <td>{{ _( "System Proxy Status" ) }}</td>
            <td id="proxy-status"></td>
        </tr>
        <tr>
            <td>{{ _( "Listening Proxy" ) }}</td>
            <td id="proxy-listen"></td>
        </tr>
        <tr>
            <td>{{ _( "PAC URL" ) }}</td>
            <td id="pac-url"></td>
        </tr>
        <tr>
            <td>IPv6</td>
            <td id="ipv6-status"></td>
        </tr>
    </tbody>
</table>

<h4 pro="True" hidden>Appid</h4>
<table id="appids" class="table table-bordered table-striped" pro="True" hidden>
    <thead>
        <tr>
            <th width="25%">{{ _( "Property" ) }}</th>
            <th width="75%">{{ _( "Value" ) }}</th>
        </tr>
    </thead>
    <tbody>
        <tr id="hidden-appids">
            <td>{{ _( "Working AppIDs" ) }}</td>
            <td id="working-appid"></td>
        </tr>
        <tr id="tr-out-of-quota-appids" hidden="true">
            <td>{{ _( "Out-of-quota AppIDs" ) }}</td>
            <td id="out-of-quota-appids"></td>
        </tr>
        <tr id="tr-not-exist-appids" hidden="true">
            <td>{{ _( "Nonexistent AppIDs" ) }}</td>
            <td id="not-exist-appids"></td>
        </tr>
    </tbody>
</table>

<h4 pro="True" hidden>{{ _( "System Version" ) }}</h4>
<table id="version" class="table table-bordered table-striped" pro="True" hidden>
    <thead>
        <tr>
            <th width="25%">{{ _( "Property" ) }}</th>
            <th width="75%">{{ _( "Value" ) }}</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>XX-Net Version</td>
            <td id="xxnet-version"></td>
        </tr>
        <tr>
            <td>Python Version</td>
            <td id="python-version"></td>
        </tr>
        <tr>
            <td>System Platform</td>
            <td id="sys-platform"></td>
        </tr>
        <tr>
            <td>OS System</td>
            <td id="os-system"></td>
        </tr>
        <tr>
            <td>OS Version</td>
            <td id="os-version"></td>
        </tr>
        <tr>
            <td>OS Release</td>
            <td id="os-release"></td>
        </tr>
        <tr>
            <td>OS Detail</td>
            <td id="os-detail"></td>
        </tr>
        <tr>
            <td>Language</td>
            <td id="language"></td>
        </tr>
        <tr>
            <td>Architecture</td>
            <td id="architecture"></td>
        </tr>
        <tr>
            <td>Browser</td>
            <td id="browser"></td>
        </tr>
    </tbody>
</table>

<div pro="True" hidden>
    <button id="pop-up-report" class="btn btn-primary">{{ _( "Feedback" ) }}</button>
    <br><br>
    <div id="tip">
            <a href="https://github.com/XX-net/XX-Net/issues">{{ _("Check Github issues") }}</a>{{ _(" or ")}} <a href="https://groups.google.com/forum/#!forum/xx-net">Google Group{{ _(" Discussions") }}</a><br>
    </div>
</div>
<!-- pro mode: show advanced information.-->

<div id="report-issue-modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>{{ _( "Diagnostic Info" ) }}</h3>
    </div> <!-- .modal-header -->
    <div class="modal-body">
        <p> * {{ _( "The one-key feedback needs to sign in your Github account" ) }}</p>
        <textarea id="DiagInfo" onmouseover="this.focus();this.select()"></textarea>
    </div>
    <div class="modal-footer">
        <a href="https://groups.google.com/forum/#!forum/xx-net"  id="go-to-google-group" class="btn btn-primary " target="_blank">{{ _( "To Google Groups" ) }}</a>
        <a href="https://github.com/XX-net/XX-Net/issues"  id="one-key-issue" class="btn btn-success " target="_blank">{{ _( "One-key feedback" ) }}</a>
    </div> <!-- .modal-footer -->
</div> <!-- #report-issue-modal -->

<!-- JavaScript -->
<script type="text/javascript">
    title('{{ _( "GAE Proxy Status Info" ) }}');
</script>
<script type="text/javascript">
    function OneKeyReport(){
        $.ajax({
            type: 'GET',
            url: '/module/gae_proxy/control/status',
            dataType: 'JSON',
            success: function(result) {
                var information = new Array(
                    'sys-platform: ' + result['sys_platform'],
                    'os-system: ' + result['os_system'],
                    'os-version: ' + result['os_version'],
                    'os-release: ' + result['os_release'],
                    'os-detail: ' + result['os_detail'],
                    'architecture: ' + String(result['architecture'].concat()),
                    'browser: ' + result['browser'],
                    'xxnet-version: ' + result['xxnet_version'],
                    'python-version: ' + result['python_version'],

                    '\nipv6-status: ' + result['use_ipv6'],
                    'gws-ip-num: ' + result['ip_num'] + ' / ' + result['good_ip_num'],
                    'network-status: ' + result['network_state'],
                    'connected-link: ' + result['connected_link_new'] + " / " + result['connected_link_used'],
                    'scan-ip-thread-num: ' + result['scan_ip_thread_num'],
                    'ip-quality: ' + result['ip_quality'],
                    'block-stat: ' + result['block_stat'],
                    'proxy_state: ' + test_http_proxy_setting(),
                    'ca_state: ' + test_https_proxy_setting(),

                    'Appid_Working: ' + (result['working_appid'].length != 0),
                    'Appids_Out_Of_Quota: ' + (result['out_of_quota_appids'].length != 0),
                    'Appids_Not_Exist: ' + (result['not_exist_appids'].length != 0),
                    'Using_Public_Appid: ' + is_public_appid(result['gae_appid'])
                    );

                updateProperty("textarea#DiagInfo","XX-Net Status：\n\n" + information.join("\n"));

                IssueURL = 'https://github.com/XX-net/XX-Net/issues/new?body=-----------%0A问题描述：%0A请在此描述你遇到的问题，必要时贴出相关的日志信息。%0A%0A-----------%0A诊断信息：%0A' + encodeURIComponent(information.join("\n")) + ";";
                $("a#one-key-issue").attr("href",IssueURL);
                GGroupURL = "https://groups.google.com/forum/#!forum/xx-net";
                // The one-key generaton function is to be designed as Github does有待设计类似Github Issue的一键生成功能
                $("a#go-to-google-group").attr("href", GGroupURL);
            }
          })
    }
</script>
<script type="text/javascript">
    $(document).ready(function(){
        var timer = $.timer(function() {
            updateStatus();
        });

        timer.set({
            time: 1000,
            autostart: true
        });

        updateStatus();
    });

    $("#pop-up-report").click(function(){
        OneKeyReport();
        $('#report-issue-modal').modal();
    });

    $("#show_detail").click(function(){
            $("[pro='True']").show();
            $("[pro='False']").hide();
            updateDetailStatus();
    });
</script>
<script type="text/javascript">
    function updateStatus(){
        if ( $("[pro='False']").is(":visible")){
            updateNoobStatus();
        }else{
            updateDetailStatus();
        }
    }

    function updateProperty(selector, content) {
        var previousContent = $(selector).html();
        if (String(previousContent) != String(content)) {
            $(selector).html(content);
        }
    }
    function updateDetailStatus() {
        $.ajax({
            type: 'GET',
            url: '/module/gae_proxy/control/status',
            dataType: 'JSON',
            success: function(result) {
                if ( test_http_proxy_setting() == "OK"){
                    var ca_status_str = test_https_proxy_setting();
                    $("#tr_ca-status").show();
                }else{
                    var ca_status_str = "";
                    $("#tr_ca-status").hide();
                }

                var updates = {
                    'td#sys-platform': result['sys_platform'],
                    'td#os-system': result['os_system'],
                    'td#os-version': result['os_version'],
                    'td#os-release': result['os_release'],
                    'td#os-detail': result['os_detail'],
                    'td#language': result['language'],
                    'td#architecture': String(result['architecture'].concat()),
                    'td#browser': result['browser'],
                    'td#xxnet-version': result['xxnet_version'],
                    'td#python-version': result['python_version'],

                    'td#proxy-listen': result['proxy_listen'],
                    'td#pac-url': result['pac_url'],
                    'td#ipv6-status': result['use_ipv6'] == '0' ? '{{ _( "Disabled" ) }}' : '{{ _( "Enabled" ) }}',

                    'td#working-appid': appid_string(result['working_appid']),
                    'td#out-of-quota-appids': result['out_of_quota_appids'],
                    'td#not-exist-appids': result['not_exist_appids'],

                    'td#network-status': result['network_state'] ? "OK" : "Fail",
                    'td#ip-num': result['good_ip_num'],
                    'td#connection-status': connection_status_string(result['connected_link_new'], result['connected_link_used']),
                    'td#browser-proxy-setting': test_http_proxy_setting(),
                    'td#ca-status': ca_status_str,
                    'td#scan-ip-thread-num': result['scan_ip_thread_num'],
                    'td#ip-quality': result['ip_quality'],
                    'td#block-stat': result['block_stat']

                }
                for (var item in updates) {
                    updateProperty(item, updates[item]);
                }

                if (result['out_of_quota_appids'] === ""){
                    $('#tr-out-of-quota-appids').hide();
                }else{
                    $('#tr-out-of-quota-appids').show();
                }

                if (result['not_exist_appids'] === ""){
                    $('#tr-not-exist-appids').hide();
                }else{
                    $('#tr-not-exist-appids').show();
                }

                if ( !tipHasClose() ) {
                    tipClose();
                }
            },
            error: function(result) {
                var formValue = $('#sys-platform').html();

                if ( tipHasClose() ) {
                    $('html, body').animate({
                        scrollTop: 0
                    }, 'slow');
                }

                if ( formValue == '' ) {
                    tip('{{ _("The status page is empty. Highly likely that GAEProxy failed getting started. Please follow ")}}<a href="https://github.com/XX-net/XX-Net/wiki/How-to-get-start-error-log" target="_blank">{{ _("guide ")}}</a>{{ _("to troubleshoot.")}}<br>', 'warning', false);
                } else {
                    tip('{{ _("No response from GAEProxy process. It might have already exited.")}}', 'warning', false);
                }
            }
        });
    }


    function updateNoobStatus() {
        $.ajax({
            type: 'GET',
            url: '/module/gae_proxy/control/status',
            dataType: 'JSON',
            success: function(result) {
                if ( !result['network_state']){
                    return updateProperty('#noob-info', '{{ _( "Your local network failed. Please check your network and firewall. " ) }}');
                }

                if ( result['good_ip_num'] < 1){
                    if ( result['scan_ip_thread_num'] < 3 ){
                        return updateProperty('#noob-info', '{{ _( "You may want to <a href=\"./?module=gae_proxy&menu=scan_ip\">turn on IP scaner</a>." ) }}');
                    }else{
                        return updateProperty('#noob-info', '{{ _( "XX-Net is scanning IP. Please wait about half an hour." ) }}');
                    }
                }

                if ( (result['connected_link_new'] + result['connected_link_used']) < 1 ){
                    return updateProperty('#noob-info', '{{ _( "</p><p>Connection not established yet. </p><p>" ) }}');
                }


                if (result['working_appid'] == ""){
                    return updateProperty('#noob-info', '{{ _( "No working appid. Please check. " ) }}');
                }

                if ( test_http_proxy_setting() == "Fail" ){
                    return updateProperty('#noob-info', '<a href="https://github.com/XX-net/XX-Net/wiki/%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86" target="_blank">' + '{{ _( "Please check your browser proxy setting." ) }}' + '</a>');
                } else  if ( test_http_proxy_setting() == "Detecting" ){
                    return updateProperty('#noob-info', '{{ _( "Detecting..." ) }}');
                }

                if ( test_https_proxy_setting() == "Fail"){
                    return updateProperty('#noob-info', '<a href="https://github.com/XX-net/XX-Net/wiki/GoAgent-Import-CA" target="_blank">' + '{{ _( "Please import certificates to your browser." ) }}' + '</a>');
                } else  if ( test_https_proxy_setting() == "Detecting" ){
                    return updateProperty('#noob-info', '{{ _( "Detecting..." ) }}');
                }

                if ( is_public_appid(result['working_appid']) ){
                    return updateProperty('#noob-info', '{{ _( "You are using public APPID. You are recommended to <a href=\"https://github.com/XX-net/XX-Net/wiki/Register-Google-appid\" target=\"_blank\">deploy your own APPID</a>" ) }}');
                }

                return updateProperty('#noob-info', "XX-Net " + result['xxnet_version'] + '{{ _( ", Everything is OK. Welcome to the FREE Internet. " ) }}');

            },
            error: function(result) {
                var infoValue = $('#noob-info').html();
                if ( infoValue == '' ) {
                    tip('{{ _("The status page is empty. Highly likely that GAEProxy failed getting started. Please follow ")}}<a href="https://github.com/XX-net/XX-Net/wiki/How-to-get-start-error-log" target="_blank">{{ _("guide ")}}</a>{{ _("to troubleshoot.")}}<br>', 'warning', false);
                } else {
                    updateProperty('#noob-info', '{{ _("No response from GAEProxy process. It might have already exited.")}}');
                }
            }
        });
    }
    function appid_string(appid){
        if (is_public_appid(appid)){
            return "{{ _( "You are using the public Appid." ) }}";
        }else{
            return appid;
        }
    }
    function is_public_appid(appids){
        var appid_list = appids.split("|");
        for (index = 0; index < appid_list.length; ++index) {
            var appid = appid_list[index];
            var app_pre = appid.slice(0, 6);
         
            if (app_pre != "xxnet-"){
                return false;
            }
        }
        return true;
    }
    function connection_status_string(network_state, connected_link_new, connected_link_used){
        if ( connected_link_new + connected_link_used == 0 && !network_state ){
            return '{{ _( "Your local network failed. " ) }}';
        }
        var tip = connected_link_new + connected_link_used > 0 ? '{{ _( "Connected to the world" ) }}':'{{ _( "Connection not established yet" ) }}'
        var conn_str = connected_link_new + "; " + connected_link_used + " (" + tip + ")";
        return conn_str;
    }
    function proxy_status_string(proxy_state,proxy_url){
        if (proxy_state == "Auto proxy enabled"){
            return '{{ _( "Auto proxy enabled at " ) }}' + proxy_url
        }else if (proxy_state == "Proxy enabled"){
            return '{{ _( "Proxy enabled at " ) }}' + proxy_url
        }else{
            return '{{ _( "Proxy disabled" ) }}'
        }
    }

    function test_http_proxy_setting() {
        if (window.http_proxy_setting === "OK") {
            return "OK";
        }

        $.ajax({
            type: 'GET',
            dataType: 'text',
            crossDomain: true,
            timeout: 1000,
            url: 'http://www.twitter.com/xxnet',
            success: function(result) {
                if ( result == "OK" ){
                    window.http_proxy_setting = "OK";
                }else{
                    window.http_proxy_setting = "Fail";
                }
            },
            error: function(result, textStatus, errorThrown) {
                window.http_proxy_setting = "Fail";
            },
        });

        if (window.http_proxy_setting === "Fail") {
            return "Fail";
        }
        return "Detecting";
    }

    function test_https_proxy_setting() {
        if (window.https_proxy_setting === "OK") {
            return "OK";
        }

        $.ajax({
            type: 'GET',
            dataType: 'text',
            crossDomain: true,
            timeout: 1000,
            url: 'https://www.twitter.com/xxnet',
            success: function(result) {
                if ( result == "OK" ){
                    window.https_proxy_setting = "OK";
                }else{
                    window.https_proxy_setting = "Fail";
                }
            },
            error: function(result, textStatus, errorThrown) {
                window.https_proxy_setting = "Fail";
            },
        });

        if (window.https_proxy_setting === "Fail") {
            return "Fail";
        }
        return "Detecting";
    }
    test_http_proxy_setting();
    test_https_proxy_setting();
</script>


