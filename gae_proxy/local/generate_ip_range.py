#!/usr/bin/env python
# -*- coding: utf-8 -*-

__author__ = 'moonshawdo@gamil.com'


import re
import ip_utils

# This code functions:
# read ip range string in code
# merge over lapped range
# filter out bad ip range

# Then reproduce good format file


# Support format(支持的格式):
# # Comment (#后面为注释）
#
# range seperater:
# 每个范围可以用 逗号(,) 和竖线(|) 或分行进行分割
#
# Single rang format: (单个范围的格式)：
# "xxx.xxx.xxx-xxx.xxx-xxx" （范围格式）
# "xxx.xxx.xxx."            （前缀格式）
# "xxx.xxx.xxx.xxx/xx"      （掩码格式）
# "xxx.xxx.xxx.xxx"         （单个ip）

input_good_range_lines = '''
1.0.0.0-1.0.0.255
1.1.1.0-1.1.1.255
1.2.3.0-1.2.3.255
1.9.22.0-1.9.22.255
1.9.24.0-1.9.24.255
1.9.57.0-1.9.57.255
1.9.131.0-1.9.131.255
1.179.248.0-1.179.255.255
1.255.22.0-1.255.22.255
1.255.33.0-1.255.33.255
4.3.2.0-4.3.2.255
4.31.38.0-4.31.38.255
4.35.2.0-4.35.2.255
4.35.108.0-4.35.108.255
4.35.153.0-4.35.153.255
4.53.36.0-4.53.36.255
4.53.56.0-4.53.56.255
4.59.90.0-4.59.90.255
5.22.190.0-5.22.190.255
5.102.252.0-5.102.252.255
8.6.48.0-8.6.55.255
8.8.4.0-8.8.4.255
8.8.8.0-8.8.8.255
8.15.202.0-8.15.202.255
8.22.56.0-8.22.63.255
8.34.208.0-8.34.223.255
8.35.80.0-8.35.80.255
8.35.192.0-8.35.207.255
12.216.80.0-12.216.80.255
23.228.128.0-23.228.191.255
23.236.48.0-23.236.63.255
23.239.5.0-23.239.5.255
23.251.128.0-23.251.159.255
23.255.128.0-23.255.255.255
24.116.134.0-24.116.134.255
24.156.131.0-24.156.131.255
24.156.153.0-24.156.153.255
24.214.95.0-24.214.95.255
24.220.112.0-24.220.112.255
27.90.140.0-27.90.142.255
27.90.189.0-27.90.189.255
27.100.64.0-27.100.64.255
27.106.94.0-27.106.94.255
27.121.46.0-27.121.46.255
27.121.51.0-27.121.51.255
27.121.54.0-27.121.54.255
27.123.212.0-27.123.212.255
31.7.160.0-31.7.160.255
31.55.162.0-31.55.163.255
31.55.166.0-31.55.167.255
31.55.184.0-31.55.184.255
31.209.137.0-31.209.137.255
31.210.208.0-31.210.208.255
37.8.144.0-37.8.144.255
37.29.1.0-37.29.1.255
37.139.254.0-37.139.254.255
37.228.69.0-37.228.69.255
41.77.223.0-41.77.223.255
41.84.159.0-41.84.159.255
41.201.128.0-41.201.128.255
41.201.164.0-41.201.164.255
41.205.32.0-41.205.32.255
41.206.64.0-41.206.64.255
41.206.96.0-41.206.96.255
41.254.36.0-41.254.36.255
42.112.8.0-42.112.9.255
45.56.0.0-45.56.63.255
45.62.108.0-45.62.108.255
45.64.20.0-45.64.20.255
45.120.85.0-45.120.85.255
46.16.9.0-46.16.9.255
46.21.52.0-46.21.52.255
46.28.246.0-46.28.247.255
46.61.155.0-46.61.155.255
46.108.1.0-46.108.1.255
46.249.159.0-46.249.159.255
49.98.24.0-49.98.25.255
49.98.35.0-49.98.35.255
49.106.234.0-49.106.234.255
49.243.141.0-49.243.141.255
58.27.27.0-58.27.27.255
58.27.61.0-58.27.61.255
58.27.108.0-58.27.109.255
58.123.102.0-58.123.102.255
58.145.238.0-58.145.238.255
58.162.16.0-58.162.16.255
58.162.62.0-58.162.62.255
58.176.217.0-58.176.217.255
58.205.224.0-58.205.224.255
58.240.77.0-58.240.77.255
59.18.34.0-59.18.35.255
59.18.44.0-59.18.44.255
59.78.209.0-59.78.209.255
59.190.145.0-59.190.145.255
60.199.175.0-60.199.175.255
61.19.1.0-61.19.2.255
61.19.8.0-61.19.8.255
61.33.130.0-61.33.130.255
61.36.166.0-61.36.166.255
61.37.150.0-61.37.150.255
61.41.59.0-61.41.59.255
61.47.115.0-61.47.115.255
61.86.203.0-61.86.203.255
61.91.18.0-61.91.18.255
61.114.99.0-61.114.99.255
61.122.213.0-61.122.213.255
61.205.127.0-61.205.127.255
61.219.131.0-61.219.131.255
61.238.203.0-61.238.203.255
61.238.239.0-61.238.239.255
61.245.3.0-61.245.3.255
62.0.54.0-62.0.54.255
62.1.38.0-62.1.38.255
62.8.95.0-62.8.95.255
62.20.124.0-62.20.124.255
62.24.158.0-62.24.158.255
62.116.207.0-62.116.207.255
62.119.230.0-62.119.230.255
62.149.79.0-62.149.79.255
62.197.198.0-62.197.198.255
62.201.216.0-62.201.216.255
62.212.252.0-62.212.252.255
62.214.62.0-62.214.62.255
62.253.3.0-62.253.3.255
63.88.73.0-63.88.73.255
63.96.4.0-63.96.4.255
63.110.67.0-63.110.67.255
63.117.14.0-63.117.14.255
63.117.68.0-63.117.68.255
63.117.215.0-63.117.215.255
63.211.200.72-63.211.200.79
63.243.168.0-63.243.168.255
64.9.224.0-64.9.255.255
64.15.112.0-64.15.127.255
64.18.0.0-64.18.15.255
64.41.221.192-64.41.221.207
64.53.242.0-64.53.242.255
64.68.64.64-64.68.64.127
64.68.80.0-64.68.95.255
64.71.249.0-64.71.249.255
64.154.178.208-64.154.178.223
64.233.160.0-64.233.191.255
65.39.199.0-65.39.199.255
65.55.58.0-65.55.58.255
65.196.188.0-65.196.188.255
65.199.32.0-65.199.32.255
65.199.248.0-65.199.248.255
66.102.0.0-66.102.255.255
66.185.84.0-66.185.85.255
66.185.95.0-66.185.95.255
66.249.64.0-66.249.95.255
67.50.19.0-67.50.19.255
69.13.115.0-69.13.117.255
69.13.126.0-69.13.126.255
69.13.199.0-69.13.199.255
69.13.201.0-69.13.201.255
69.13.203.0-69.13.203.255
69.17.141.0-69.17.141.255
69.46.66.0-69.46.66.255
69.65.64.0-69.65.64.255
70.32.128.0-70.32.159.255
70.90.219.48-70.90.219.55
70.90.219.72-70.90.219.79
72.14.192.0-72.14.255.255
74.85.65.0-74.85.65.255
74.125.0.0-74.125.255.255
74.207.242.0-74.207.242.255
77.37.250.0-77.37.250.255
77.37.252.0-77.37.252.255
77.40.222.0-77.40.222.255
77.42.248.0-77.42.255.255
77.66.9.0-77.66.9.255
77.88.221.0-77.88.221.255
77.91.67.0-77.91.67.255
77.109.131.0-77.109.131.255
77.153.128.0-77.153.128.255
78.8.8.0-78.8.8.255
78.37.100.0-78.37.100.255
78.37.112.0-78.37.112.255
78.83.4.0-78.83.4.255
78.90.240.0-78.90.240.255
78.144.6.0-78.144.6.255
79.101.111.0-79.101.111.255
79.106.107.0-79.106.107.255
79.136.239.0-79.136.239.255
79.171.163.0-79.171.163.255
80.64.175.0-80.64.175.255
80.80.3.0-80.80.3.255
80.89.192.0-80.89.192.255
80.93.31.0-80.93.31.255
80.149.20.0-80.149.20.255
80.227.152.0-80.227.152.255
80.228.65.0-80.228.65.255
80.231.69.0-80.231.69.255
80.239.168.0-80.239.168.255
80.239.174.0-80.239.174.255
80.239.229.0-80.239.229.255
80.252.129.0-80.252.129.255
81.93.175.0-81.93.175.255
81.175.29.0-81.175.29.255
82.94.228.0-82.94.228.255
82.135.118.0-82.135.118.255
82.178.32.0-82.178.32.255
83.94.121.0-83.94.121.255
83.100.221.0-83.100.221.255
83.140.66.0-83.140.66.255
83.141.89.0-83.141.89.255
83.145.196.0-83.145.196.255
83.220.157.0-83.220.157.255
83.233.164.0-83.233.164.255
84.233.219.0-84.233.219.255
84.235.58.0-84.235.58.255
84.235.77.0-84.235.77.255
84.244.61.0-84.244.61.255
85.112.116.0-85.112.116.255
85.112.121.0-85.112.121.255
85.113.229.0-85.113.229.255
85.158.132.0-85.158.132.255
85.172.1.0-85.172.1.255
85.182.250.0-85.182.250.255
86.51.24.0-86.51.24.255
86.51.35.0-86.51.35.255
86.51.68.0-86.51.68.255
86.127.118.0-86.127.118.255
87.126.158.0-87.126.158.255
87.244.198.0-87.244.198.255
87.245.196.0-87.245.197.255
87.245.200.0-87.245.200.255
87.251.132.0-87.251.132.255
88.159.13.0-88.159.13.255
89.47.210.0-89.47.210.255
89.96.249.0-89.96.249.255
89.127.198.0-89.127.198.255
89.207.224.0-89.207.231.255
90.150.4.0-90.150.4.255
90.201.124.0-90.201.124.255
91.213.30.0-91.213.30.255
91.230.210.0-91.230.210.255
91.245.214.0-91.245.214.255
92.45.86.0-92.45.86.255
92.126.121.0-92.126.121.255
93.87.90.0-93.87.90.255
93.88.162.0-93.88.163.255
93.89.223.0-93.89.223.255
93.94.217.0-93.94.218.255
93.123.23.0-93.123.23.255
93.183.211.0-93.183.211.255
93.191.15.0-93.191.15.255
94.20.252.0-94.20.252.255
94.25.137.0-94.25.137.255
94.40.70.0-94.40.70.255
94.129.130.0-94.129.130.255
94.200.103.0-94.200.103.255
95.54.196.0-95.54.196.255
95.143.84.0-95.143.84.255
95.153.46.0-95.153.46.255
95.154.114.0-95.154.114.255
95.158.47.0-95.158.47.255
95.170.193.0-95.170.193.255
95.173.210.0-95.173.210.255
95.209.200.0-95.209.200.255
98.126.98.0-98.126.98.255
101.78.13.0-101.78.13.255
101.99.49.0-101.99.49.255
101.198.128.0-101.198.159.255
103.1.139.0-103.1.139.255
103.2.116.0-103.2.116.255
103.7.28.0-103.7.31.255
103.7.200.0-103.7.200.255
103.11.28.0-103.11.28.255
103.11.30.0-103.11.30.255
103.16.204.0-103.16.205.255
103.16.207.0-103.16.207.255
103.21.25.0-103.21.25.255
103.25.178.0-103.25.178.255
103.28.94.0-103.28.94.255
103.244.49.0-103.244.49.255
103.246.187.0-103.246.187.255
104.154.43.0-104.154.43.255
104.154.49.0-104.154.49.255
104.154.56.0-104.154.56.255
104.154.64.0-104.154.64.255
104.154.75.0-104.154.75.255
104.154.81.0-104.154.81.255
104.154.94.0-104.154.94.255
104.155.0.0-104.155.0.255
104.155.10.0-104.155.11.255
104.155.14.0-104.155.14.255
104.155.28.0-104.155.28.255
104.155.35.0-104.155.35.255
104.155.39.0-104.155.39.255
104.155.43.0-104.155.43.255
104.155.78.0-104.155.78.255
104.155.219.0-104.155.219.255
104.192.108.0-104.192.109.255
104.196.3.0-104.196.3.255
104.196.6.0-104.196.6.255
104.196.93.0-104.196.93.255
104.197.6.0-104.197.6.255
104.197.13.0-104.197.13.255
104.197.22.0-104.197.22.255
104.197.30.0-104.197.30.255
104.197.35.0-104.197.35.255
104.197.45.0-104.197.45.255
104.197.71.0-104.197.71.255
104.197.73.0-104.197.73.255
104.197.81.0-104.197.81.255
104.199.139.0-104.199.139.255
104.199.150.0-104.199.150.255
104.199.184.0-104.199.184.255
104.237.160.0-104.237.191.255
106.103.1.0-106.103.2.255
106.162.192.0-106.162.192.255
106.162.198.0-106.162.200.255
106.162.216.0-106.162.216.255
106.186.119.0-106.186.119.255
107.167.160.0-107.167.191.255
107.178.192.0-107.178.255.255
107.188.128.0-107.188.255.255
108.59.80.0-108.59.95.255
108.166.34.0-108.166.34.255
108.170.192.0-108.170.255.255
108.177.0.0-108.177.255.255
109.105.109.0-109.105.109.255
109.110.33.0-109.110.33.255
109.163.221.0-109.163.221.255
109.226.232.0-109.226.232.255
109.232.83.0-109.232.83.255
110.75.151.0-110.75.151.255
110.163.42.0-110.163.42.255
110.164.0.0-110.164.16.255
110.232.86.0-110.232.86.255
111.30.128.0-111.30.136.255
111.30.139.0-111.30.141.255
111.86.157.0-111.86.157.255
111.86.247.0-111.86.247.255
111.90.117.0-111.90.117.255
111.92.162.0-111.92.162.255
111.94.248.0-111.94.248.255
111.107.254.0-111.107.254.255
111.168.255.0-111.168.255.255
112.215.60.0-112.215.60.255
113.21.24.0-113.21.24.255
113.21.241.0-113.21.241.255
113.171.18.0-113.171.19.255
113.171.241.0-113.171.247.255
113.171.251.0-113.171.252.255
113.197.105.0-113.197.106.255
114.4.41.0-114.4.41.255
114.120.192.0-114.120.192.255
114.121.194.0-114.121.194.255
115.84.108.0-115.84.108.255
115.88.207.0-115.88.207.255
115.159.0.0-115.159.255.255
115.164.12.0-115.164.12.255
115.164.140.0-115.164.140.255
115.166.169.0-115.166.169.255
115.178.26.0-115.178.27.255
115.254.97.0-115.254.97.255
115.254.106.0-115.254.106.255
115.254.121.0-115.254.121.255
116.92.194.0-116.92.194.255
116.93.47.0-116.93.47.255
116.202.230.0-116.202.230.255
116.212.229.0-116.212.229.255
116.251.217.0-116.251.217.255
117.102.117.0-117.102.117.255
118.69.249.0-118.69.249.255
118.98.26.0-118.98.26.255
118.98.30.0-118.98.30.255
118.98.36.0-118.98.36.255
118.98.76.0-118.98.77.255
118.98.106.0-118.98.106.255
118.98.110.0-118.98.111.255
118.107.75.0-118.107.75.255
118.107.111.0-118.107.111.255
118.143.88.0-118.143.88.255
118.174.24.0-118.174.27.255
119.15.80.0-119.15.80.255
119.28.0.0-119.29.255.255
119.57.55.0-119.57.55.255
119.81.142.0-119.81.142.255
119.81.145.0-119.81.145.255
119.110.118.0-119.110.118.255
119.147.146.0-119.147.146.255
119.149.188.0-119.149.188.255
119.161.83.0-119.161.83.255
119.235.103.0-119.235.103.255
121.51.0.0-121.51.255.255
121.78.52.0-121.78.52.255
121.78.71.0-121.78.71.255
121.78.74.0-121.78.74.255
121.78.206.0-121.78.206.255
121.194.0.0-121.194.0.255
121.195.178.0-121.195.178.255
122.56.115.0-122.56.115.255
122.154.244.0-122.154.244.255
122.168.100.0-122.168.100.255
122.251.255.0-122.251.255.255
123.108.253.0-123.108.253.255
123.205.250.0-123.205.251.255
123.231.239.0-123.231.239.255
124.40.230.0-124.40.230.255
124.40.245.0-124.40.245.255
124.158.72.0-124.158.72.255
124.160.89.0-124.160.89.255
124.248.162.0-124.248.162.255
125.99.110.0-125.99.110.255
125.234.52.0-125.234.53.255
125.235.17.0-125.235.17.255
125.235.30.0-125.235.30.255
128.0.86.0-128.0.86.255
128.0.90.0-128.0.90.255
128.0.169.0-128.0.169.255
130.211.0.0-130.211.255.255
139.175.107.0-139.175.107.255
140.113.14.0-140.113.14.255
142.250.0.0-142.251.255.255
143.215.193.0-143.215.193.255
144.131.80.0-144.131.80.255
145.253.36.0-145.253.36.255
146.148.0.0-146.148.255.255
149.3.176.0-149.3.177.255
149.126.86.0-149.126.86.255
150.100.16.0-150.100.16.255
150.101.213.0-150.101.213.255
151.21.210.0-151.21.210.255
151.248.100.0-151.248.100.255
157.197.92.0-157.197.93.255
159.253.153.0-159.253.153.255
162.216.148.0-162.216.151.255
162.222.176.0-162.222.183.255
163.28.38.0-163.28.38.255
163.28.83.0-163.28.83.255
163.28.116.0-163.28.116.255
164.40.244.0-164.40.244.255
165.165.38.0-165.165.38.255
165.193.245.0-165.193.245.255
166.90.148.64-166.90.148.79
172.56.136.0-172.56.136.255
172.217.0.0-172.217.255.255
172.253.0.0-172.253.255.255
173.194.0.0-173.194.255.255
173.237.115.0-173.237.115.255
173.255.112.0-173.255.127.255
175.28.1.0-175.28.1.255
176.53.68.0-176.53.68.255
177.35.203.0-177.35.203.255
177.99.189.0-177.99.189.255
177.100.48.0-177.100.48.255
178.35.137.0-178.35.137.255
178.45.249.0-178.45.249.255
178.45.251.0-178.45.251.255
178.45.253.0-178.45.253.255
178.60.128.0-178.60.128.255
178.250.208.0-178.250.208.255
180.149.59.0-180.149.59.255
180.180.248.0-180.180.248.255
182.50.94.0-182.50.94.255
182.79.251.0-182.79.251.255
182.79.253.0-182.79.254.255
182.163.240.0-182.163.240.255
182.239.95.0-182.239.95.255
182.248.204.0-182.248.204.255
182.254.0.0-182.254.255.255
183.78.5.0-183.78.5.255
183.87.151.0-183.87.151.255
183.91.18.0-183.91.18.255
183.182.96.0-183.182.96.255
184.150.182.0-184.150.182.255
185.2.108.0-185.2.108.255
185.13.132.0-185.13.132.255
185.25.28.0-185.25.31.255
186.46.140.0-186.46.140.255
186.73.79.0-186.73.79.255
186.215.155.0-186.215.155.255
187.72.192.0-187.72.192.255
188.21.9.0-188.21.9.255
188.43.64.0-188.43.66.255
188.47.194.0-188.47.194.255
188.113.128.0-188.113.128.255
189.14.52.0-189.14.52.255
189.45.9.0-189.45.9.255
189.59.93.0-189.59.93.255
189.89.161.0-189.89.161.255
190.57.224.0-190.57.224.255
190.98.170.0-190.98.170.255
190.211.175.0-190.211.175.255
190.235.154.0-190.235.154.255
190.241.121.0-190.241.121.255
190.248.35.0-190.248.35.255
192.30.252.0-192.30.252.255
192.86.102.0-192.86.102.255
192.119.16.0-192.119.31.255
192.158.28.0-192.158.31.255
192.178.0.0-192.179.255.255
192.193.133.0-192.193.133.255
192.200.224.0-192.200.255.255
193.4.115.0-193.4.115.255
193.33.5.0-193.33.5.255
193.51.224.0-193.51.224.255
193.90.147.0-193.90.147.255
193.92.133.0-193.92.133.255
193.95.144.0-193.95.144.255
193.105.163.0-193.105.163.255
193.120.166.0-193.120.166.255
193.134.255.0-193.134.255.255
193.142.125.0-193.142.125.255
193.186.4.0-193.186.4.255
193.192.226.0-193.192.226.255
193.192.250.0-193.192.250.255
193.200.222.0-193.200.222.255
193.247.193.0-193.247.193.255
194.44.4.0-194.44.4.255
194.44.64.0-194.44.64.255
194.78.20.0-194.78.20.255
194.78.99.0-194.78.99.255
194.90.196.0-194.90.196.255
194.100.132.0-194.100.132.255
194.106.173.0-194.106.173.255
194.110.194.0-194.110.194.255
194.116.101.0-194.116.101.255
194.122.80.0-194.122.82.255
194.221.68.0-194.221.68.255
195.12.177.0-195.12.177.255
195.13.231.0-195.13.231.255
195.50.84.0-195.50.84.255
195.65.133.0-195.65.133.255
195.76.16.0-195.76.16.255
195.81.83.0-195.81.83.255
195.100.224.0-195.100.224.255
195.122.16.0-195.122.16.255
195.141.3.0-195.141.3.255
195.149.238.0-195.149.238.255
195.205.170.0-195.205.170.255
195.229.194.0-195.229.194.255
195.244.106.0-195.244.106.255
195.244.120.0-195.244.120.255
195.249.20.0-195.249.20.255
196.3.58.0-196.3.59.255
196.23.168.0-196.23.168.255
196.27.66.0-196.27.66.255
197.80.128.0-197.80.128.255
197.84.128.0-197.84.128.255
197.149.150.0-197.149.150.255
197.157.244.0-197.157.244.255
197.199.253.0-197.199.254.255
197.253.18.0-197.253.18.255
198.70.68.0-198.70.68.255
198.108.100.192-198.108.100.207
198.142.187.0-198.142.187.255
199.87.241.0-199.87.241.255
199.192.112.0-199.192.115.255
199.223.232.0-199.223.239.255
200.29.113.0-200.29.113.255
200.40.3.0-200.40.3.255
200.53.245.0-200.53.245.255
200.56.193.0-200.56.193.255
200.77.168.0-200.77.168.255
200.77.222.0-200.77.222.255
200.94.238.0-200.94.238.255
200.105.131.0-200.105.131.255
200.149.119.0-200.149.119.255
200.172.62.0-200.172.62.255
200.195.190.0-200.195.190.255
201.31.84.0-201.31.84.255
201.86.233.0-201.86.233.255
201.157.30.0-201.157.30.255
201.167.64.0-201.167.64.255
201.248.78.0-201.248.78.255
202.3.240.0-202.3.240.255
202.28.85.0-202.28.85.255
202.38.180.0-202.38.180.255
202.39.143.0-202.39.143.255
202.40.221.0-202.40.221.255
202.51.67.0-202.51.67.255
202.58.96.0-202.58.97.255
202.65.246.0-202.65.246.255
202.67.41.0-202.67.41.255
202.69.26.0-202.69.26.255
202.70.58.0-202.70.58.255
202.76.239.0-202.76.239.255
202.78.113.0-202.78.113.255
202.86.162.0-202.86.162.255
202.88.157.0-202.88.157.255
202.88.186.0-202.88.186.255
202.93.153.0-202.93.153.255
202.106.93.0-202.106.93.255
202.122.145.0-202.122.146.255
202.128.12.0-202.128.12.255
202.136.185.0-202.136.185.255
202.148.204.0-202.148.204.255
202.152.130.0-202.152.130.255
202.152.192.0-202.152.192.255
202.158.57.0-202.158.57.255
202.159.216.0-202.159.216.255
202.169.173.0-202.169.173.255
202.169.175.0-202.169.175.255
202.169.193.0-202.169.193.255
202.208.170.0-202.208.170.255
202.216.0.0-202.216.0.255
202.220.161.0-202.220.161.255
202.224.62.0-202.224.62.255
202.224.83.0-202.224.83.255
202.248.151.0-202.248.151.255
203.42.8.0-203.42.8.255
203.42.38.0-203.42.38.255
203.42.93.0-203.42.93.255
203.66.124.0-203.66.124.255
203.78.32.0-203.78.32.255
203.78.36.0-203.78.36.255
203.82.75.0-203.82.75.255
203.82.77.0-203.82.77.255
203.94.209.0-203.94.209.255
203.113.160.0-203.113.160.255
203.114.135.0-203.114.135.255
203.116.165.0-203.116.165.255
203.117.34.0-203.117.37.255
203.133.8.0-203.133.8.255
203.146.98.0-203.146.98.255
203.151.116.0-203.151.116.255
203.165.13.0-203.165.14.255
203.176.178.0-203.176.178.255
203.176.180.0-203.176.180.255
203.192.223.0-203.192.223.255
203.195.128.0-203.195.255.255
203.205.128.0-203.205.255.255
203.207.55.0-203.207.55.255
203.208.32.0-203.208.63.255
203.210.2.0-203.210.2.255
203.210.4.0-203.210.4.255
203.211.0.0-203.211.0.255
203.217.98.0-203.217.98.255
203.233.10.0-203.233.10.255
203.233.18.0-203.233.18.255
203.233.63.0-203.233.63.255
203.233.88.0-203.233.88.255
203.233.126.0-203.233.126.255
203.248.180.0-203.248.180.255
203.248.210.0-203.248.210.255
204.85.30.0-204.85.30.255
206.111.13.0-206.111.13.255
206.169.145.0-206.169.145.255
206.248.151.0-206.248.151.255
207.126.144.0-207.126.159.255
207.134.64.0-207.134.64.255
207.223.160.0-207.223.175.255
207.249.186.0-207.249.186.255
208.21.209.0-208.21.209.15
208.54.64.0-208.54.64.255
208.65.152.0-208.65.155.255
208.76.186.0-208.76.186.255
208.117.224.0-208.117.255.255
209.85.128.0-209.85.255.255
209.116.150.0-209.116.150.255
209.118.7.0-209.118.7.255
209.118.208.0-209.118.208.255
209.185.108.128-209.185.108.255
209.245.184.136-209.245.184.143
209.247.159.144-209.247.159.159
210.2.185.0-210.2.185.255
210.61.221.0-210.61.221.255
210.139.253.0-210.139.253.255
210.143.70.0-210.143.70.255
210.143.147.0-210.143.147.255
210.153.73.0-210.153.73.255
210.158.146.0-210.158.146.255
210.187.22.0-210.187.22.255
210.187.25.0-210.187.25.255
210.242.125.0-210.242.128.255
210.245.14.0-210.245.14.255
211.124.13.0-211.124.13.255
211.125.201.0-211.125.201.255
211.175.187.0-211.175.187.255
211.181.65.0-211.181.65.255
212.0.195.0-212.0.195.255
212.1.249.0-212.1.249.255
212.20.34.0-212.20.34.255
212.39.82.0-212.39.82.255
212.56.71.0-212.56.71.255
212.57.191.0-212.57.191.255
212.106.221.0-212.106.221.255
212.113.7.0-212.113.7.255
212.122.6.0-212.122.6.255
212.122.14.0-212.122.14.255
212.126.123.0-212.126.123.255
212.142.160.0-212.142.160.255
212.154.168.0-212.154.168.255
212.162.51.0-212.162.51.255
212.181.117.0-212.181.117.255
212.188.7.0-212.188.7.255
212.188.10.0-212.188.10.255
212.188.15.0-212.188.15.255
212.188.49.0-212.188.49.255
213.24.121.0-213.24.121.255
213.31.219.0-213.31.219.255
213.55.64.0-213.55.64.255
213.85.209.0-213.85.209.255
213.151.210.0-213.151.210.255
213.152.1.0-213.152.1.255
213.155.151.0-213.155.151.255
213.158.11.0-213.158.11.255
213.186.229.0-213.186.229.255
213.187.184.0-213.187.184.255
213.208.156.0-213.208.156.255
213.240.44.0-213.240.44.255
213.241.88.0-213.241.88.255
213.242.89.0-213.242.89.255
213.252.15.0-213.252.15.255
216.21.160.0-216.21.175.255
216.33.229.0-216.33.229.255
216.58.192.0-216.58.223.255
216.109.75.80-216.109.75.95
216.239.32.0-216.239.63.255
216.239.90.0-216.239.90.255
217.19.150.0-217.19.150.255
217.28.250.0-217.28.250.255
217.28.253.0-217.28.253.255
217.30.152.0-217.30.152.255
217.33.127.0-217.33.127.255
217.119.79.0-217.119.79.255
217.149.45.0-217.149.45.255
217.163.7.0-217.163.7.255
217.193.96.0-217.193.96.255
218.176.242.0-218.176.242.255
218.189.25.0-218.189.25.255
218.208.3.0-218.208.3.255
218.253.0.0-218.253.0.255
219.117.35.0-219.117.35.255
219.124.146.0-219.124.146.255
220.102.0.0-220.102.0.255
220.225.89.0-220.225.89.255
220.255.0.0-220.255.0.255
220.255.5.0-220.255.6.255
221.133.8.0-221.133.8.255
221.241.81.0-221.241.81.255
222.165.163.0-222.165.163.255
222.251.134.0-222.251.134.255
222.255.120.0-222.255.120.255
223.26.69.0-223.26.69.255
223.27.237.0-223.27.237.255
223.62.225.0-223.62.225.255
223.196.4.0-223.196.4.255
223.196.82.0-223.196.82.255
'''

input_bad_ip_range_lines  = """
45.64.20.0/24   	    #中国澳门
58.205.224.0/24			#湖北省武汉市华中科技大学教育网无线校园项目
58.205.224.0/24 	    #中国	湖北	武汉	华中科技大学
58.240.77.0/24  		#中国	江苏	南京
58.240.77.0/24			#江苏省南京市联通
59.78.209.0/24  		#中国	上海	上海
59.78.209.0/24			#上海市腾讯公司教育网节点
101.198.128.0/19		#北京市奇虎360科技有限公司
103.7.28.0/22			#香港腾讯公司数据中心
110.75.151.0/24 		#中国	浙江	杭州
111.30.128.0/24 		#中国	天津	天津
111.30.136.0/24 		#中国	天津	天津
111.30.139.0/24 		#中国	天津	天津
111.30.140.0/24 		#中国	天津	天津
115.159.0.0/24  		#中国	上海	上海
119.28.0.0/16			#香港北京康盛新创科技有限责任公司
119.29.0.0/16			#广东省广州市海珠区腾讯云服务器(广州市海珠区新港中路397号TIT创意园)
119.29.0.0/24   		#中国	广东	广州
119.29.17.0/24  		#中国	广东	广州
119.57.55.0/24  		#中国	北京	北京
119.57.55.0/24			#北京市东四IDC机房
119.147.146.0/24		#中国	广东	东莞
121.51.0.0/24   		#中国	广东
121.194.0.0/24  		#中国	北京	北京
121.195.178.0/24		#中国	北京	北京
124.160.89.0/24 		#中国	浙江	杭州
130.211.0.0/16          #用了会出现错误
182.254.0.0/24  		#中国	广东	广州
202.69.26.0/24  		#中国	广东	深圳
202.86.162.0/24 		#中国	澳门
202.106.93.0/24 		#中国	北京	北京
203.195.128.0/24		#中国	广东	广州
203.208.32.0/24 		#中国	北京	北京	GOOGLE
203.208.40.0/24 		#中国	北京	北京	GOOGLE
203.208.41.0/24 		#中国	北京	北京	GOOGLE
203.208.48.0/24 		#中国	北京	北京	GOOGLE
203.208.49.0/24 		#中国	北京	北京	GOOGLE
203.208.50.0/24 		#中国	北京	北京	GOOGLE
203.208.52.0/24 		#中国	北京	北京	GOOGLE
203.205.128.0/19		#香港腾讯公司数据中心
255.255.255.255/32      #for algorithm
"""

def PRINT(strlog):
    print (strlog)

def print_range_list(ip_range_list):
    for ip_range in ip_range_list:
        begin = ip_range[0]
        end = ip_range[1]
        print ip_utils.ip_num_to_string(begin), ip_utils.ip_num_to_string(end)


def parse_range_string(input_lines):
    ip_range_list = []

    ip_lines_list = re.split("\r|\n", input_lines)
    for raw_line in ip_lines_list:
        raw_s = raw_line.split("#")
        context_line = raw_s[0]

        context_line = context_line.replace(' ', '')

        ips = re.split(",|\|", context_line)
        for line in ips:
            if len(line) == 0:
                #print "non line:", line
                continue
            begin, end = ip_utils.split_ip(line)
            if ip_utils.check_ip_valid(begin) == 0 or ip_utils.check_ip_valid(end) == 0:
                PRINT("ip format is error,line:%s, begin: %s,end: %s" % (line, begin, end))
                continue
            nbegin = ip_utils.ip_string_to_num(begin)
            nend = ip_utils.ip_string_to_num(end)
            ip_range_list.append([nbegin,nend])
            #print begin, end

    ip_range_list.sort()

    return ip_range_list

def merge_range(input_ip_range_list):
    output_ip_range_list = []
    range_num = len(input_ip_range_list)

    last_begin = input_ip_range_list[0][0]
    last_end = input_ip_range_list[0][1]
    for i in range(1,range_num):
        ip_range = input_ip_range_list[i]
        begin = ip_range[0]
        end = ip_range[1]

        #print "now:",ip_utils.ip_num_to_string(begin), ip_utils.ip_num_to_string(end)

        if begin > last_end + 2:
            #print "add:",ip_utils.ip_num_to_string(begin), ip_utils.ip_num_to_string(end)
            output_ip_range_list.append([last_begin, last_end])
            last_begin = begin
            last_end = end
        else:
            print "merge:", ip_utils.ip_num_to_string(last_begin), ip_utils.ip_num_to_string(last_end), ip_utils.ip_num_to_string(begin), ip_utils.ip_num_to_string(end)
            if end > last_end:
                last_end = end

    output_ip_range_list.append([last_begin, last_end])

    return output_ip_range_list

def filter_ip_range(good_range, bad_range):
    out_good_range = []
    bad_i = 0
    bad_range_num = len(bad_range)

    bad_begin, bad_end = bad_range[bad_i]

    for good_begin, good_end in good_range:
        while True:
            if good_begin > good_end:
                PRINT("bad good ip range when filter:%s-%s"  % (ip_utils.ip_num_to_string(good_begin), ip_utils.ip_num_to_string(good_end)))
            if good_end < bad_begin:
                # case:
                #     [  good  ]
                #                   [  bad  ]
                out_good_range.append([good_begin, good_end])
                break
            elif bad_end < good_begin:
                # case:
                #                   [  good  ]
                #     [   bad   ]
                bad_i += 1
                bad_begin, bad_end = bad_range[bad_i]
                continue
            elif good_begin <= bad_begin and good_end <= bad_end:
                # case:
                #     [   good    ]
                #           [   bad   ]
                PRINT("cut bad ip case 1:%s - %s" % (ip_utils.ip_num_to_string(bad_begin), ip_utils.ip_num_to_string(good_end)))
                if bad_begin - 1 > good_begin:
                    out_good_range.append([good_begin, bad_begin - 1])
                break
            elif good_begin >= bad_begin and good_end >= bad_end:
                # case:
                #           [   good   ]
                #     [    bad  ]
                PRINT("cut bad ip case 2:%s - %s" % (ip_utils.ip_num_to_string(good_begin), ip_utils.ip_num_to_string(bad_end)))
                good_begin = bad_end + 1
                bad_i += 1
                bad_begin, bad_end = bad_range[bad_i]
                continue
            elif good_begin <= bad_begin and good_end >= bad_end:
                # case:
                #     [     good     ]
                #         [  bad  ]
                out_good_range.append([good_begin, bad_begin - 1])
                PRINT("cut bad ip case 3:%s - %s" % (ip_utils.ip_num_to_string(bad_begin), ip_utils.ip_num_to_string(bad_end)))
                good_begin = bad_end + 1
                bad_i += 1
                bad_begin, bad_end = bad_range[bad_i]
                continue
            elif good_begin >= bad_begin and good_end <= bad_end:
                # case:
                #          [good]
                #      [    bad    ]
                PRINT("cut bad ip case 4:%s - %s" % (ip_utils.ip_num_to_string(good_begin), ip_utils.ip_num_to_string(good_end)))
                break
            else:
                PRINT("any case?")

    return out_good_range

def generate_ip_range():
    ip_range_list = parse_range_string(input_good_range_lines)
    ip_range_list = merge_range(ip_range_list)
    PRINT("Good ip range:\n")
    print_range_list(ip_range_list)

    bad_range_list = parse_range_string(input_bad_ip_range_lines)
    bad_range_list = merge_range(bad_range_list)
    PRINT("Bad ip range:\n")
    print_range_list(ip_range_list)

    ip_range_list = filter_ip_range(ip_range_list, bad_range_list)
    PRINT("Output ip range:\n")
    print_range_list(ip_range_list)

    # write out
    fd = open("ip_range.txt", "w")
    for ip_range in ip_range_list:
        begin = ip_range[0]
        end = ip_range[1]
        #print ip_utils.ip_num_to_string(begin), ip_utils.ip_num_to_string(end)
        fd.write(ip_utils.ip_num_to_string(begin)+ "-" + ip_utils.ip_num_to_string(end)+"\n")

    fd.close()


def test_load():
    print("Begin test load ip_range.txt\n")
    fd = open("ip_range.txt", "r")
    if not fd:
        print "open ip_range.txt fail."
        exit()

    amount = 0
    for line in fd.readlines():
        if len(line) == 0 or line[0] == '#':
            continue
        begin, end = ip_utils.split_ip(line)

        nbegin = ip_utils.ip_string_to_num(begin)
        nend = ip_utils.ip_string_to_num(end)

        num = nend - nbegin
        amount += num
        print ip_utils.ip_num_to_string(nbegin), ip_utils.ip_num_to_string(nend), num

    fd.close()
    print "amount ip:", amount


def main():
    generate_ip_range()
    test_load()


if __name__ == "__main__":
    main()
